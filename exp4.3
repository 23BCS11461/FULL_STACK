// ticketSystem.js - Concurrent Ticket Booking System using Node.js & Express
const express = require("express");
const app = express();
app.use(express.json());

let seats = Array.from({ length: 10 }, (_, i) => ({
  id: i + 1,
  status: "available",
  lockedBy: null,
  lockTime: null
}));

// HTML Frontend
app.get("/", (req, res) => {
  res.send(`
    <!DOCTYPE html>
    <html lang="en">
    <head><meta charset="UTF-8"><title>Ticket Booking System</title></head>
    <body style="font-family:Arial; padding:20px;">
      <h2>Concurrent Ticket Booking System</h2>
      <button onclick="loadSeats()">View Seats</button>
      <ul id="seatList"></ul>
      <script>
        async function loadSeats() {
          const res = await fetch('/seats');
          const data = await res.json();
          document.getElementById('seatList').innerHTML = data.map(
            s => '<li>Seat ' + s.id + ' - ' + s.status + '</li>'
          ).join('');
        }
      </script>
    </body>
    </html>
  `);
});

// Auto unlock expired seats every 10s
setInterval(() => {
  const now = Date.now();
  seats.forEach(s => {
    if (s.status === "locked" && now - s.lockTime > 60000) {
      s.status = "available";
      s.lockedBy = null;
      s.lockTime = null;
    }
  });
}, 10000);

// View all seats
app.get("/seats", (req, res) => res.json(seats));

// Lock a seat
app.post("/lock/:id", (req, res) => {
  const { user } = req.body;
  const seat = seats.find(s => s.id == req.params.id);
  if (!seat) return res.status(404).json({ message: "Seat not found" });
  if (seat.status === "booked") return res.status(400).json({ message: "Seat already booked" });
  if (seat.status === "locked") return res.status(400).json({ message: "Seat is locked" });

  seat.status = "locked";
  seat.lockedBy = user;
  seat.lockTime = Date.now();
  res.json({ message: `Seat ${seat.id} locked by ${user}` });
});

// Confirm booking
app.post("/confirm/:id", (req, res) => {
  const { user } = req.body;
  const seat = seats.find(s => s.id == req.params.id);
  if (!seat) return res.status(404).json({ message: "Seat not found" });
  if (seat.status === "booked") return res.status(400).json({ message: "Already booked" });
  if (seat.lockedBy !== user) return res.status(400).json({ message: "Seat not locked by this user" });

  seat.status = "booked";
  seat.lockedBy = null;
  seat.lockTime = null;
  res.json({ message: `Seat ${seat.id} successfully booked by ${user}` });
});

app.listen(3000, () => console.log("Server running on http://localhost:3000"));
