// transferApp.js - Account Transfer System with Balance Validation
const express = require("express");
const mongoose = require("mongoose");
const app = express();
app.use(express.json());

// MongoDB Connection
mongoose.connect("mongodb://localhost:27017/bankDB", { useNewUrlParser: true, useUnifiedTopology: true })
  .then(() => console.log("Connected to MongoDB"))
  .catch(err => console.log("DB Connection Error:", err));

// Account Model
const accountSchema = new mongoose.Schema({
  name: String,
  balance: Number
});
const Account = mongoose.model("Account", accountSchema);

// Create sample accounts (only run once if needed)
app.get("/seed", async (req, res) => {
  await Account.deleteMany({});
  await Account.insertMany([
    { name: "Alice", balance: 1000 },
    { name: "Bob", balance: 500 }
  ]);
  res.json({ message: "Sample accounts created" });
});

// View all accounts
app.get("/accounts", async (req, res) => {
  const data = await Account.find();
  res.json(data);
});

// Transfer money
app.post("/transfer", async (req, res) => {
  const { from, to, amount } = req.body;

  if (amount <= 0) return res.status(400).json({ message: "Invalid amount" });

  const sender = await Account.findOne({ name: from });
  const receiver = await Account.findOne({ name: to });

  if (!sender || !receiver) return res.status(404).json({ message: "Sender or receiver not found" });
  if (sender.balance < amount) return res.status(400).json({ message: "Insufficient balance" });

  // Sequential updates (no transactions)
  sender.balance -= amount;
  receiver.balance += amount;
  await sender.save();
  await receiver.save();

  res.json({ message: "Transfer successful", from: sender, to: receiver });
});

app.listen(3000, () => console.log("Server running on http://localhost:3000"));
